
@prefix rdf:   <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix sh:    <http://www.w3.org/ns/shacl#> .
@prefix xsd:   <http://www.w3.org/2001/XMLSchema#> .
@prefix rdfs:  <http://www.w3.org/2000/01/rdf-schema#> .
@prefix ex:    <http://www.example.org/#> .
@prefix owl:   <http://www.w3.org/2002/07/owl#> .
@prefix ompd: <http://spec.equonto.org/ontology/maintenance-procedure/static-procedure-ontology#>
@prefix lis: <http://rds.posccaesar.org/ontology/lis14/rdl/>
@prefix proc: <http://spec.equonto.org/ontology/maintenance-procedure/static-procedure-ontology/instances#>

proc:NoTasksInProcedureShape
    a sh:NodeShape ;
    sh:targetClass ompd:MaintenanceProcedureProcess ; 
    sh:property [           
        sh:path ompd:hasDirectActivityPart ;    
        sh:minCount 1 ;
    ] ;
    sh:closed false;
    sh:ignoredProperties ( rdf:type owl:topDataProperty owl:topObjectProperty ) ;
.

proc:OrphanedTask 
    a sh:NodeShape ;
    sh:targetClass ompd:MaintenanceTask ; 
    sh:property [           
        sh:path ompd:directActivityPartOf ;    
        sh:minCount 1 ;
        sh:or (
         [
           sh:class ompd:MaintenanceTask  ]
         [
           sh:class ompd:MaintenanceProcedureProcess  ]
        )
    ] ;
    sh:closed false;
    sh:ignoredProperties ( rdf:type owl:topDataProperty owl:topObjectProperty ) ;
.

proc:TaskWithoutSequence a sh:NodeShape ;
  sh:target [
    a sh:SPARQLTarget ;
    sh:select """
    PREFIX ompd: <http://www.example.org/static-procedure-ontology#> 
    SELECT ?this
    WHERE {
    ?this a ompd:MaintenanceTask .
    ?this ompd:directActivityPartOf ?parent .
    {
        SELECT ?parent (COUNT(?this) AS ?taskCount)
        WHERE {
            ?this a ompd:MaintenanceTask .
            ?this ompd:directActivityPartOf ?parent .
    }
    GROUP BY ?parent
    HAVING (COUNT(?this) > 1)
  }
}""" ;
  ] ;
sh:or (
		[
			sh:path lis:before ;
			sh:minCount 1 ;
		]
		[
			sh:path lis:after ;
			sh:minCount 1 ;
		]
) .


proc:NoMaintainableItemShape a sh:NodeShape ;
sh:targetClass ompd:MaintenanceProcedureProcess ;
sh:closed false;
sh:sparql [
  sh:message "Procedure does not have a maintainable item.";
  sh:select """
 	PREFIX ompd: <http://spec.equonto.org/ontology/maintenance-procedure/static-procedure-ontology#>
 	PREFIX lis: <http://rds.posccaesar.org/ontology/lis14/rdl/>
 	SELECT ?this 
   	  WHERE { 
            ?this a ompd:MaintenanceProcedureProcess . 
           FILTER NOT EXISTS {
            ?this lis:hasParticipant ?item .
            ?item a ompd:MaintainableItem .
         }

   }""" ;
  ] ;
  .



proc:NotAMaintenanceTask a sh:NodeShape ;
sh:targetClass ompd:MaintenanceTask ;
sh:closed false;
sh:sparql [
  sh:message "Maintenance Task ({?this}) does not contain a maintenance action.";
  sh:select """
 	PREFIX ompd: <http://spec.equonto.org/ontology/maintenance-procedure/static-procedure-ontology#>
 	PREFIX lis: <http://rds.posccaesar.org/ontology/lis14/rdl/>
 	SELECT ?this 
   	WHERE { 
           ?this a ompd:MaintenanceTask . 
           FILTER NOT EXISTS {
            ?this lis:hasActivityPart ?item .
            ?item a ompd:MaintenanceAction .
           }
   	}""" ;
  ] ;
  .


proc:MaintenanceActionWithNoItem
    a sh:NodeShape ;
    sh:targetClass ompd:MaintenanceAction ; 
    sh:property [           
        sh:path ompd:hasPatient ;    
        sh:minCount 1 ;
    ] ;
    sh:closed false;
    sh:ignoredProperties ( rdf:type owl:topDataProperty owl:topObjectProperty ) ;
.

# TODO: check this one
proc:ToolWithoutActivity a sh:NodeShape ;
sh:targetClass ompd:Tool;
sh:closed false;
sh:sparql [
  sh:message "Tool at task level exists with no agent";
  sh:select """
 	PREFIX ompd: <http://spec.equonto.org/ontology/maintenance-procedure/static-procedure-ontology#>
 	PREFIX lis: <http://rds.posccaesar.org/ontology/lis14/rdl/>
 	SELECT ?this 
   	  WHERE { 
           ?this a ompd:Tool . 
           ?this a ompd:Extracted .
           FILTER NOT EXISTS {
              ?this lis:agentOf ?activity .
              ?item a ompd:MaintenanceAction .
          }
   }""" ;
  ] ;
  .